version: '3.9'
name: tp1
services:
  client:
    container_name: client
    image: client:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - server

  server:
    container_name: server
    image: server:latest
    entrypoint: python3 /main.py
    restart: on-failure
    external_links:
      - rabbitmq
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - initial_column_cleaner

  initial_column_cleaner:
    container_name: initial_column_cleaner
    image: initial_column_cleaner:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - avg_calculator_1
      - avg_calculator_2
      - filter_by_average_1
      - filter_by_average_2

  query_handler:
    container_name: query_handler
    image: query_handler:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1

  avg_calculator_1:
    container_name: avg_calculator_1
    image: avg_calculator:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - filter_by_average_1
      - filter_by_average_2

  avg_calculator_2:
    container_name: avg_calculator_2
    image: avg_calculator:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - filter_by_average_1
      - filter_by_average_2

  filter_by_average_1:
    container_name: filter_by_average_1
    image: filter_by_average:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - group_by_route_query_4

  filter_by_average_2:
    container_name: filter_by_average_2
    image: filter_by_average:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
    depends_on:
      - group_by_route_query_4

  group_by_route_query_4:
    container_name: group_by_route
    image: group_by:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - FIELD_GROUP_BY=startingAirport,destinationAirport
      - LISTENING_QUEUE=filtered_by_average
      - REDUCERS_AMOUNT=2
      - QUEUE_GROUP_BY=group_by_route_queue_q4
      - INPUT_QUEUE=group_by_route

  reducer_group_by_route_q4_1:
    container_name: reducer_group_by_route_q4_1
    image: reducer_group_by:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - FIELD_GROUP_BY=route
      - INPUT_QUEUE=group_by_route_queue_q4_1
      - OUTPUT_QUEUE=output
      - QUERY_NUMBER=4
    depends_on:
      - query_handler

  reducer_group_by_route_q4_2:
    container_name: reducer_group_by_route_q4_2
    image: reducer_group_by:latest
    entrypoint: python3 /main.py
    environment:
      - PYTHONUNBUFFERED=1
      - FIELD_GROUP_BY=route
      - INPUT_QUEUE=group_by_route_queue_q4_2
      - OUTPUT_QUEUE=output
      - QUERY_NUMBER=4
    depends_on:
      - query_handler
